<!-- Informa√ß√µes do Usu√°rio -->
<div class="user-info-container">
  <div class="user-info-card">
    <div class="info-section">
      <div class="info-item">
        <span class="info-label">üë§ Colaborador:</span>
        <div class="user-status-container">
          <span class="info-value">{{ nomeUsuario }}</span>
          <span
            class="status-indicator"
            [ngClass]="{'online': isOnline, 'offline': !isOnline}"
          ></span>
        </div>
      </div>
      <div class="info-item">
        <span class="info-label">üïí In√≠cio do Expediente:</span>
        <span class="info-value">
          {{ horaInicioExpediente || 'N√£o iniciado' }}
        </span>
      </div>
      <div class="info-item">
        <span class="info-label">üèÅ Fim do Expediente:</span>
        <span
          class="info-value"
          [ngClass]="{'status-em-andamento': !horaFimExpediente}"
        >
          {{ horaFimExpediente || 'Em andamento' }}
        </span>
      </div>
    </div>

    <div class="date-filter-section">
      <div class="date-filter">
        <span class="info-label">üìÖ Selecione uma Data:</span>
        <input
          type="date"
          [(ngModel)]="dataSelecionada"
          (change)="filtrarPorData()"
          class="date-input"
          [max]="hoje"
        />
      </div>
    </div>
  </div>
</div>

<!-- Mapas -->
<div class="maps-container">
  <div class="map-box">
    <h3>Localiza√ß√£o Atual</h3>
    <div id="mapUserLocation" class="map"></div>
    <div class="map-actions">
      <button
        class="btn-location"
        (click)="verMinhaLocalizacao()"
        title="Ver minha localiza√ß√£o atual"
      >
        üìç Ver Minha Localiza√ß√£o
      </button>
    </div>
  </div>

  <div class="map-box">
    <h3>Local de In√≠cio do Expediente</h3>
    <div id="mapShiftLocation" class="map"></div>
  </div>
</div>

<!-- Cont√™iner para os trajetos -->
<div class="routes-container">
  <h3>üöó Trajetos</h3>

  <div class="table-responsive">
    <!-- Mensagem quando n√£o h√° dados -->
    <div *ngIf="mensagemSemDados" class="alert alert-info text-center">
      {{ mensagemSemDados }}
    </div>

    <!-- Tabela s√≥ √© mostrada quando h√° dados -->
    <table class="styled-table" *ngIf="!mensagemSemDados">
      <!-- Legenda para acessibilidade -->
      <caption>Lista de ordens de servi√ßo registradas</caption>
      <thead>
        <tr>
          <th (click)="ordenarPor('ordemServico')">
            Ordem de Servi√ßo ‚¨ç
          </th>
          <th (click)="ordenarPor('enderecoInicio')">
            Local de In√≠cio ‚¨ç
          </th>
          <th (click)="ordenarPor('horaInicio')">
            Hora In√≠cio ‚¨ç
          </th>
          <th (click)="ordenarPor('enderecoFim')">
            Local de Fim ‚¨ç
          </th>
          <th (click)="ordenarPor('horaFim')">
            Hora Fim ‚¨ç
          </th>
          <th>A√ß√µes</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let trajeto of trajetosFiltrados">
          <td>{{ trajeto.ordemServico }}</td>
          <td class="endereco-cell">
            {{ trajeto.enderecoInicio }}
            <button
              *ngIf="trajeto.latitudeInicio"
              class="btn-maps"
              (click)="abrirGoogleMapsComCoordenadas(trajeto.latitudeInicio, trajeto.longitudeInicio)"
              title="Ver no Google Maps"
            >
              üó∫Ô∏è
            </button>
            <span
              *ngIf="trajeto.enderecoInicio === 'Carregando...'"
              class="loading-indicator"
            >
              ‚åõ
            </span>
          </td>
          <td class="hora-cell">
            {{ trajeto.horaInicio || 'N/A' }}
          </td>
          <td class="endereco-cell">
            {{ trajeto.enderecoFim }}
            <button
              *ngIf="trajeto.latitudeFim"
              class="btn-maps"
              (click)="abrirGoogleMapsComCoordenadas(trajeto.latitudeFim, trajeto.longitudeFim)"
              title="Ver no Google Maps"
            >
              üó∫Ô∏è
            </button>
            <span
              *ngIf="trajeto.enderecoFim === 'Carregando...'"
              class="loading-indicator"
            >
              ‚åõ
            </span>
          </td>
          <td class="hora-cell">
            {{ trajeto.horaFim || 'N/A' }}
          </td>
          <td class="action-cell">
            <button
              class="btn-map"
              (click)="verNoMapa(trajeto)"
              title="Ver a rota no mapa"
            >
              ‚Üù
            </button>
            <button
              *ngIf="trajeto.formularioId"
              class="btn-form"
              (click)="verFormulario(trajeto)"
              title="Ver formul√°rio"
            >
              üìã
            </button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<!-- Se√ß√£o de Formul√°rios -->
<div *ngFor="let trajeto of trajetosFiltrados">
  <div
    *ngIf="formulariosAbertos[trajeto.formularioId]"
    class="formulario-container"
    [id]="'formulario-' + trajeto.formularioId"
  >
    <div class="formulario-header">
      <h4>üìã Formul√°rio - O.S. {{ trajeto.ordemServico }}</h4>
      <button
        class="btn-close"
        (click)="verFormulario(trajeto)"
        title="Fechar formul√°rio"
      >
        ‚úï
      </button>
    </div>
    
    <div class="formulario-content" *ngIf="formularioSelecionado">
      <!-- Informa√ß√µes Gerais -->
      <div class="form-section">
        <h5>‚ÑπÔ∏è Informa√ß√µes Gerais</h5>
        <div class="info-grid">
          <div class="info-item">
            <label>Data:</label>
            <span>{{ formularioSelecionado.dataPreenchimento | date:'dd/MM/yyyy HH:mm' }}</span>
          </div>
          <div class="info-item">
            <label>T√©cnico:</label>
            <span>{{ formularioSelecionado.tecnicoNome }}</span>
          </div>
        </div>
      </div>

      <!-- Checklist -->
      <div class="form-section">
        <h5>‚úîÔ∏è Checklist</h5>
        <table class="checklist-table">
          <thead>
            <tr>
              <th>Item</th>
              <th>Status</th>
              <th>Observa√ß√£o</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let item of formularioSelecionado.checklist">
              <td>{{ item.item }}</td>
              <td>
                <span [class]="'status-' + item.status.toLowerCase()">
                  {{ item.status }}
                </span>
              </td>
              <td>{{ item.observacao || '-' }}</td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Material Utilizado -->
      <div class="form-section">
        <h5>üõ†Ô∏è Material Utilizado</h5>
        <table class="material-table">
          <thead>
            <tr>
              <th>C√≥digo</th>
              <th>Descri√ß√£o</th>
              <th>Quantidade</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let material of formularioSelecionado.materialUtilizado">
              <td>{{ material.codigo }}</td>
              <td>{{ material.descricao }}</td>
              <td>{{ material.quantidade }}</td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Fotos -->
      <div class="form-section">
        <h5>üì∏ Fotos do Servi√ßo</h5>
        <div class="fotos-grid">
          <div class="foto-item" *ngFor="let foto of formularioSelecionado.fotos">
            <img [src]="foto.url" [alt]="foto.descricao">
            <div class="foto-info">
              <p>{{ foto.descricao }}</p>
              <small>{{ foto.dataHora | date:'dd/MM/yyyy HH:mm' }}</small>
            </div>
          </div>
        </div>
      </div>

      <!-- Observa√ß√µes -->
      <div class="form-section">
        <h5>üìù Observa√ß√µes Gerais</h5>
        <p class="observacoes">{{ formularioSelecionado.observacoesGerais }}</p>
      </div>

      <!-- Assinatura -->
      <div class="form-section">
        <h5>‚úçÔ∏è Assinatura do Cliente</h5>
        <div class="assinatura-container">
          <img [src]="formularioSelecionado.assinaturaCliente" alt="Assinatura do cliente">
        </div>
      </div>
    </div>
  </div>
</div>
