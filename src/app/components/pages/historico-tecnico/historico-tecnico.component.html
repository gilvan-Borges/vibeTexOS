<div class="user-info-container">
  <div class="user-info-card">
    <div class="info-section">
      <div class="info-item">
        <span class="info-label">üë§ Colaborador:</span>
        <div class="user-status-container">
          <span class="info-value">{{ nomeUsuario }} - {{ nomeDaEmpresa}}</span>
          <span
            class="status-indicator"
            [ngClass]="{'online': isOnline, 'offline': !isOnline}"
          ></span>
        </div>
      </div>
      <div class="info-item">
        <span class="info-label">üïí In√≠cio do Expediente:</span>
        <span class="info-value">
          {{ horaInicioExpediente || 'N√£o iniciado' }}
        </span>
      </div>
      <div class="info-item">
        <span class="info-label">üèÅ Fim do Expediente:</span>
        <span
          class="info-value"
          [ngClass]="{'status-em-andamento': !horaFimExpediente}"
        >
          {{ horaFimExpediente || 'Em andamento' }}
        </span>
      </div>
    </div>

    <div class="date-filter-section">
      <div class="date-filter">
        <span class="info-label">üìÖ Selecione uma Data:</span>
        <input
          type="date"
          [(ngModel)]="dataSelecionada"
          (change)="filtrarPorData()"
          class="date-input"
          [max]="hoje"
        />
      </div>
    </div>
  </div>
</div>

<!-- Mapas -->
<div class="maps-container">
  <div class="map-box">
    <h3>Rota Selecionada</h3>
    <div id="mapUserLocation" class="map"></div>
    <div class="map-actions">
      <button
        class="btn-location"
        (click)="verMinhaLocalizacao()"
        title="Ver minha localiza√ß√£o atual"
      >
        üìç Ver Minha Localiza√ß√£o
      </button>
    </div>
  </div>

  <div class="map-box">
    <h3>Locais de In√≠cio de Execu√ß√£o</h3>
    <div id="mapShiftLocation" class="map"></div>
  </div>
</div>

<!-- Cont√™iner para os trajetos -->
<div class="routes-container">
  <h3>üöó Trajetos</h3>

  <div class="table-responsive">
    <!-- Mensagem quando n√£o h√° dados -->
    <div *ngIf="mensagemSemDados" class="alert alert-info text-center">
      {{ mensagemSemDados }}
    </div>

    <!-- Tabela s√≥ √© mostrada quando h√° dados -->
    <table class="styled-table" *ngIf="!mensagemSemDados">
      <caption>Lista de ordens de servi√ßo registradas</caption>
      <thead>
        <tr>
          <th style="width: 80px;" (click)="ordenarPor('ordemServico')">
            O.S. ‚¨ç
          </th>
          <th (click)="ordenarPor('nomeCliente')">
            Cliente ‚¨ç
          </th>
          <th (click)="ordenarPor('cpfCliente')">
            CPF ‚¨ç
          </th>
          <th (click)="ordenarPor('enderecoInicio')">
            Bairro ‚¨ç
          </th>
          <th (click)="ordenarPor('tipoServico')">
            Tipo de Servi√ßo ‚¨ç
          </th>
          <th (click)="ordenarPor('status')">
            Status ‚¨ç
          </th>
          <th>Rota</th>
          <th>Execu√ß√£o</th>
          <th>Formul√°rio</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let trajeto of trajetosFiltrados">
          <td>{{ formatarCodigoOS(trajeto.ordemServico) }}</td>
          <td>{{ trajeto.nomeCliente }}</td>
          <td>{{ trajeto.cpfCliente }}</td>
          <td class="endereco-cell">
            {{ trajeto.enderecoInicio }}
            <button
              *ngIf="trajeto.latitudeInicio && trajeto.latitudeInicio !== 0"
              class="btn-maps"
              (click)="abrirGoogleMapsComCoordenadas(trajeto.latitudeInicio, trajeto.longitudeInicio)"
              title="Ver no Google Maps"
            >
              üó∫Ô∏è
            </button>
            <span
              *ngIf="trajeto.enderecoInicio === 'Carregando...'"
              class="loading-indicator"
            >
              ‚åõ
            </span>
          </td>
          <td>{{ trajeto.tipoServico }}</td>
          <td>{{ trajeto.status }}</td>
          <td>
            <button
              *ngIf="trajeto.hasTrajetoCoordenadas"
              class="btn-map"
              (click)="mostrarRotaNoMapa(trajeto, 'trajeto')"
              title="Ver a rota do trajeto no mapa"
            >
              ‚Üù
            </button>
            <span *ngIf="!trajeto.hasTrajetoCoordenadas" class="text-muted">
              Indispon√≠vel
            </span>
          </td>
          <td>
            <button
              *ngIf="trajeto.hasExecucaoCoordenadas"
              class="btn-map"
              (click)="mostrarRotaNoMapa(trajeto, 'execucao')"
              title="Ver a rota da execu√ß√£o no mapa"
            >
              ‚Üù
            </button>
            <span *ngIf="!trajeto.hasExecucaoCoordenadas" class="text-muted">
              Indispon√≠vel
            </span>
          </td>
          <td>
            <button
              *ngIf="trajeto.formularioId"
              class="btn-form"
              (click)="abrirFormulario(trajeto)"
              title="Ver formul√°rio"
            >
              üìã
            </button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<!-- Se√ß√£o do Formul√°rio na Parte Inferior -->
<div *ngIf="mostrarFormulario" class="formulario-container mt-4">
  <h3>Formul√°rio da Ordem de Servi√ßo {{ trajetoSelecionado?.ordemServico }}</h3>
  <form [formGroup]="formularioServico">
    <!-- Se√ß√£o: Dados da O.S. -->
    <div class="form-section">
      <h4 class="section-title">Dados da O.S.</h4>
      <div class="row mb-3">
        <div class="col-md-12">
          <label for="codigoOS" class="form-label">C√≥digo O.S.</label>
          <input type="text" id="codigoOS" class="form-control" formControlName="codigoOS" readonly>
        </div>
      </div>
    </div>

    <!-- Se√ß√£o: Dados do Colaborador -->
    <div class="form-section">
      <h4 class="section-title">Dados do Colaborador</h4>
      <div class="row mb-3">
        <div class="col-md-6">
          <label for="nomeColaborador" class="form-label">Nome do Colaborador</label>
          <input type="text" id="nomeColaborador" class="form-control" formControlName="nomeColaborador" readonly>
        </div>
        <div class="col-md-6">
          <label for="empresaColaborador" class="form-label">Empresa</label>
          <input type="text" id="empresaColaborador" class="form-control" formControlName="empresaColaborador" readonly>
        </div>
      </div>
    </div>

    <!-- Se√ß√£o: Dados do Cliente -->
    <div class="form-section">
      <h4 class="section-title">Dados do Cliente</h4>
      <div class="row mb-3">
        <div class="col-md-6">
          <label for="nomeCliente" class="form-label">Nome do Cliente</label>
          <input type="text" id="nomeCliente" class="form-control" formControlName="nomeCliente" readonly>
        </div>
        <div class="col-md-6">
          <label for="cpf" class="form-label">CPF</label>
          <input type="text" id="cpf" class="form-control" formControlName="cpf" readonly>
        </div>
      </div>
      <div class="row mb-3">
        <div class="col-md-6">
          <label for="telefone" class="form-label">Telefone</label>
          <input type="text" id="telefone" class="form-control" formControlName="telefone" readonly>
        </div>
        <div class="col-md-6">
          <label for="cep" class="form-label">CEP</label>
          <input type="text" id="cep" class="form-control" formControlName="cep" readonly>
        </div>
      </div>
      <div class="row mb-3">
        <div class="col-md-6">
          <label for="logradouro" class="form-label">Logradouro</label>
          <input type="text" id="logradouro" class="form-control" formControlName="logradouro" readonly>
        </div>
        <div class="col-md-3">
          <label for="numero" class="form-label">N√∫mero</label>
          <input type="text" id="numero" class="form-control" formControlName="numero" readonly>
        </div>
        <div class="col-md-3">
          <label for="complemento" class="form-label">Complemento</label>
          <input type="text" id="complemento" class="form-control" formControlName="complemento" readonly>
        </div>
      </div>
      <div class="row mb-3">
        <div class="col-md-4">
          <label for="bairro" class="form-label">Bairro</label>
          <input type="text" id="bairro" class="form-control" formControlName="bairro" readonly>
        </div>
        <div class="col-md-4">
          <label for="cidade" class="form-label">Cidade</label>
          <input type="text" id="cidade" class="form-control" formControlName="cidade" readonly>
        </div>
        <div class="col-md-4">
          <label for="estado" class="form-label">Estado</label>
          <input type="text" id="estado" class="form-control" formControlName="estado" readonly>
        </div>
      </div>
    </div>

    <!-- Se√ß√£o: Observa√ß√µes -->
    <div class="form-section">
      <h4 class="section-title">Observa√ß√µes</h4>
      <div class="row mb-3">
        <div class="col-md-12">
          <label for="observacoes" class="form-label">Observa√ß√µes</label>
          <textarea id="observacoes" class="form-control" formControlName="observacoes" rows="3" readonly></textarea>
        </div>
      </div>
    </div>

    <!-- Se√ß√£o: Fotos -->
    <div class="form-section">
      <h4 class="section-title">Fotos</h4>
      <div class="row mb-3">
        <div class="col-md-6">
          <label class="form-label">Foto de In√≠cio</label>
          <div class="foto-container">
            <img *ngIf="formularioServico.get('fotoInicio')?.value" [src]="formularioServico.get('fotoInicio')?.value"
              class="img-fluid rounded" alt="Foto In√≠cio">
            <p *ngIf="!formularioServico.get('fotoInicio')?.value" class="text-muted">Nenhuma foto dispon√≠vel</p>
          </div>
        </div>
        <div class="col-md-6">
          <label class="form-label">Foto de Fim</label>
          <div class="foto-container">
            <img *ngIf="formularioServico.get('fotoFim')?.value" [src]="formularioServico.get('fotoFim')?.value"
              class="img-fluid rounded" alt="Foto Fim">
            <p *ngIf="!formularioServico.get('fotoFim')?.value" class="text-muted">Nenhuma foto dispon√≠vel</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Se√ß√£o: Assinatura -->
    <div class="form-section">
      <h4 class="section-title">Assinatura do Cliente</h4>
      <div class="signature-container">
        <img *ngIf="formularioServico.get('assinatura')?.value" [src]="formularioServico.get('assinatura')?.value"
          class="img-fluid rounded" alt="Assinatura do Cliente" style="max-width: 200px; max-height: 100px;">
        <p *ngIf="!formularioServico.get('assinatura')?.value" class="text-muted">Nenhuma assinatura dispon√≠vel</p>
      </div>
    </div>

    <!-- Bot√£o para Gerar PDF -->
    <div class="form-section">
      <div class="row d-flex justify-content-center">
        <div class="col-md-6 d-flex justify-content-center gap-2">
          <button type="button" class="btn btn-primary w-100" (click)="gerarPDF()">
            Gerar PDF
          </button>
          <button type="button" class="btn btn-secondary w-100" (click)="fecharFormulario()">
            Fechar
          </button>
        </div>
      </div>
    </div>
  </form>
</div>