<div class="container mt-4">
  <h2 class="mb-4">Consulta de Ordens de Serviço</h2>

  <form [formGroup]="filtroForm" class="row g-3 mb-4">
    <div class="col-md-3">
      <label for="dataInicio" class="form-label">Data Início</label>
      <input 
        type="date" 
        class="form-control" 
        id="dataInicio" 
        formControlName="dataInicio"
        (change)="aplicarFiltros()">
    </div>

    <div class="col-md-3">
      <label for="dataFim" class="form-label">Data Fim</label>
      <input 
        type="date" 
        class="form-control" 
        id="dataFim" 
        formControlName="dataFim"
        (change)="aplicarFiltros()">
    </div>

    <div class="col-md-3">
      <label for="nomeEmpresa" class="form-label">Nome da Empresa</label>
      <input 
        type="text" 
        class="form-control" 
        id="nomeEmpresa" 
        formControlName="nomeEmpresa">
    </div>

    <div class="col-md-3">
      <label for="status" class="form-label">Status</label>
      <select class="form-select" id="status" formControlName="status">
        <option value="">Todos</option>
        <option value="Concluído">Concluído</option>
        <option value="Pendente">Pendente</option>
        <option value="Em Andamento">Em Andamento</option>
        <option value="Cancelado">Cancelado</option>
        <option value="Agendada">Agendada</option>
      </select>
    </div>

    <div class="col-12">
      <button type="button" class="btn btn-primary me-2" (click)="aplicarFiltros()">Filtrar</button>
      <button type="button" class="btn btn-secondary" (click)="limparFiltros()">Limpar</button>
    </div>
  </form>

  <div class="table-responsive">
    <table class="table table-striped table-hover">
      <thead>
        <tr>
          <th>Colaborador</th>
          <th>Número OS</th>
          <th>Data O.S.</th>
          <th>Empresa</th>
          <th>Status</th>
          <th>Descrição</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let os of ordensServicoFiltradas">
          <td>
            <ng-container *ngIf="getColaboradorFoto(os.usuarioId) as foto; else noFoto">
              <ng-container *ngIf="getColaboradorNome(os.usuarioId) as nome">
                <div class="d-flex align-items-center">
                  <img 
                    [src]="foto" 
                    class="rounded-circle me-2" 
                    width="40" 
                    height="40"
                    [alt]="nome"
                    loading="lazy"
                  >
                  <span>{{ nome }}</span>
                </div>
              </ng-container>
            </ng-container>
            <ng-template #noFoto>
              <ng-container *ngIf="getColaboradorNome(os.usuarioId) as nome">
                <div class="d-flex align-items-center">
                  <div class="rounded-circle me-2 bg-secondary d-flex align-items-center justify-content-center text-white" style="width: 40px; height: 40px;">
                    {{ nome?.charAt(0) || 'C' }}
                  </div>
                  <span>{{ nome }}</span>
                </div>
              </ng-container>
            </ng-template>
          </td>
          <td>{{ os.numeroOrdemDeServico || 'N/A' }}</td>
          <td>{{ os.dataHoraCadastro ? (os.dataHoraCadastro | date:'dd/MM/yyyy':'GMT') : 'N/A' }}</td>
          <td>{{ getEmpresaNome(os.usuarioId) }}</td>
          <td>
            <span
              class="status"
              [ngClass]="{
                'bg-green-soft': normalizeStatus(os.statusOrdem) === 'concluida',
                'bg-blue-soft': normalizeStatus(os.statusOrdem) === 'pendente',
                'bg-orange-soft': normalizeStatus(os.statusOrdem) === 'em andamento',
                'bg-red-soft': normalizeStatus(os.statusOrdem) === 'cancelado',
                'bg-brown-soft': normalizeStatus(os.statusOrdem) === 'agendada'
              }"
            >
              {{ os.statusOrdem || 'N/A' }}
            </span>
          </td>
          <td>{{ os.observacoesReparo || 'Sem descrição' }}</td>
        </tr>
        <tr *ngIf="ordensServicoFiltradas.length === 0">
          <td colspan="6" class="text-center">Nenhum registro encontrado</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>